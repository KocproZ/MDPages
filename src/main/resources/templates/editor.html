<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorator="fragments/layout">

<div layout:fragment="content">
    <div class="container">
        <div class="row">
            <form id="pageForm" method="post" th:action="${page != null} ? '/update' : '/add'">
                <input type="hidden" name="tags" id="tags-input"/>
                <div class="row wrapper">
                    <div class="mdref">test</div>
                    <div class="options">
                        <input type="hidden" name="stringId" th:value="${page != null} ? ${page.stringId} : ${''}"/>
                        <div class="row input-field">
                            <div class="col m12">
                                <input id="name-input" data-length="128" name="name"
                                       th:value="${page != null} ? ${page.name} : ''" maxlength="128"/>
                            </div>
                        </div>
                        <div class="row input-field">
                            <div class="col m12">
                                <div id="tags" class="chips chips-autocomplete chips-initial"></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col m10 input-field">
                                <select name="visibility">
                                    <option value="PUBLIC"
                                            th:selected="${visibility eq T(me.matrix89.markpages.data.model.PageModel.Visibility).PUBLIC}">
                                        Public
                                    </option>
                                    <option value="AUTHORIZED"
                                            th:selected="${visibility eq T(me.matrix89.markpages.data.model.PageModel.Visibility).AUTHORIZED}">
                                        Authorized
                                    </option>
                                    <option value="HIDDEN"
                                            th:selected="${visibility eq T(me.matrix89.markpages.data.model.PageModel.Visibility).HIDDEN}">
                                        Hidden
                                    </option>
                                </select>
                            </div>
                            <i class="col m2 input-field waves-effect waves-light btn waves-input-wrapper"
                               onclick="$('#pageForm').submit()">
                                <input class="waves-button-input" value="save" type="submit"/>
                            </i>
                            <!--<input class="col m2 input-field waves-effect waves-light btn" value="save" type="submit"/>-->
                        </div>
                    </div>
                    <div class="editor-wrapper">
                        <div class="col m12" id="editor" th:text="${page != null} ? ${page.content} : ''"></div>
                        <input type="hidden" id="contentValue" name="mdPage"/>
                    </div>
                    <div class="preview-wrapper" id="preview"></div>
                </div>
            </form>
        </div>
    </div>

    <style>
        .wrapper {
            display: grid;
            grid-gap: 50px;
            grid-template-columns: 1fr 1fr;
            grid-template-areas: "options mdref" "editor preview";
        }

        .preview-wrapper {
            grid-area: preview;
        }

        .editor-wrapper {
            grid-area: editor;
        }

        .mdref {
            grid-area: mdref;
        }

        .options {
            grid-area: options;
        }
    </style>

    <script src="/js/showdown.min.js"></script>
    <script src="/js/highlight.min.js"></script>
    <script src="/js/ace/ace.js"></script>
    <script src="/js/editor.js"></script>
    <script th:inline="javascript">

        var editor = ace.edit("editor");
        editor.setOptions({
            maxLines: Infinity
        });
        editor.setTheme("ace/theme/twilight");
        editor.session.setMode("ace/mode/markdown");
        editor.on('change', update);

        function update(e) {
            var converter = new showdown.Converter();
            converter.setOption('tasklists', true);
            converter.setOption('ghCodeBlocks', true);
            converter.setOption('tables', true);
            converter.setOption('simpleLineBreaks', true);
            var text = editor.getValue();
            var html = converter.makeHtml(text);
            document.getElementById("preview").innerHTML = html;
            document.getElementById("contentValue").value = text;
            $('pre code').each(function (i, block) {
                hljs.highlightBlock(block);
            });
        }

        /* <![CDATA[ */
        var pageTags = [[${page != null} ? ${@tagService.getPageTags(page.getStringId())} : ${null}]];//Works, but not implemented
        var allTags = [[${@tagService.getAllTags()}]];//Works, but not implemented
        /* ]]> */
        $(document).ready(function () {
            setupForm(allTags, pageTags)

        });

        setTimeout(update, 500);
    </script>

</div>
</html>
