<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.w3.org/1999/xhtml"
      layout:decorator="fragments/layout">

<div layout:fragment="content">
    <div class="container">
        <ul id="slide-out" class="side-nav" style="width:850px; background-color:#1B1B1B;">
            <div class="" id="editor" th:text="${page != null} ? ${page.content} : ''"></div>
        </ul>
        <a href="#" data-activates="slide-out" class="button-collapse">
            <div class="valign-wrapper center-align" style="position:fixed; left:0px;top:50vh;width:50px;height:50px;">
                <img src="http://www.cadencesound.com/wp-content/uploads/2017/08/arrow-right.png" style="width:50px;"/>
            </div>
        </a>
        <script>$(".button-collapse").sideNav();</script>
        <div class="row">
            <div class="col m12">
                <form id="pageForm" method="post" th:object="${pageFormDTO}"
                      th:action="${page != null} ? @{/edit/update} : @{/edit/add}">
                    <input type="hidden" id="pageContent" th:field="*{content}"/>
                    <input type="hidden" id="code" name="code"
                           th:value="${page != null} ? ${page.code} : ${''}"/>
                    <div class="row">
                        <div class="col m6">
                            <div class="row">
                                <div class="col m12 input-field">
                                    <input placeholder="Page Title" type="text" id="title-input" data-length="128"
                                           name="title" maxlength="128"
                                           th:value="${page != null} ? ${page.title} : ${''}"/>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col m12 input-field">
                                    <div class="autocomplete" id="tags">
                                        <div class="ac-tags">
                                        </div>
                                        <div class="ac-input">
                                            <input placeholder="Tags" type="text" id="tagsInput" data-activates="tagsMultipleDropdown"
                                                   data-beloworigin="true" autocomplete="off"/>
                                            <input type="hidden" class="validate" name="tags" id="hiddenTags"
                                                   th:field="*{tags}"/>
                                        </div>
                                        <ul id="tagsMultipleDropdown" class="dropdown-content ac-dropdown"></ul>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col m6 input-field mdselect-wrapper">
                                    <select name="visibility">
                                        <option value="PUBLIC"
                                                th:selected="${visibility eq T(ovh.kocproz.markpages.Visibility).PUBLIC}"> Public
                                        </option>
                                        <option value="AUTHORIZED"
                                                th:selected="${visibility eq T(ovh.kocproz.markpages.Visibility).AUTHORIZED}"> Authorized
                                        </option>
                                    </select>
                                </div>
                                <div class="col m4 offset-m2">
                                    <button class="btn waves-effect waves-light" name="action" type="submit"
                                            style="padding: 0 1rem;">Save<i class="material-icons right">save</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col m6">test</div>
                    </div>
                    <div class="row input-field"
                         th:if="${page != null ? @permissionService.getRole(page.code, #httpServletRequest.getRemoteUser())
                                  eq T(ovh.kocproz.markpages.data.model.PageMaintainerModel.Role).OWNER :
                                  true}">
                        <div class="col m12">
                            <div class="autocomplete" id="users">
                                <div class="ac-users">
                                </div>
                                <div class="ac-input">
                                    <input placeholder="Authorized users" type="text" id="usersInput" data-activates="usersMultipleDropdown"
                                           data-beloworigin="true" autocomplete="off"/>
                                    <input type="hidden" class="validate" name="users" id="hiddenUsers"
                                           th:field="*{users}"/>
                                </div>
                                <ul id="usersMultipleDropdown" class="dropdown-content ac-dropdown"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div id="preview"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/showdown.min.js"></script>
    <script src="/js/showdownExtensions.js"></script>
    <script src="/js/highlight.min.js"></script>
    <script src="/js/jquery.materialize-autocomplete.min.js"></script>
    <script src="/js/ace/ace.js"></script>
    <script src="/js/editor.js"></script>
    <script th:inline="javascript">

        var editor = ace.edit("editor");
        editor.setOptions({
            maxLines: Infinity,
            minLines: 32,    //TODO: This is arbitrary number
            wrap: true
        });
        editor.setTheme("ace/theme/twilight");
        editor.session.setMode("ace/mode/markdown");
        editor.on('change', update);

        function update() {
            var converter = new showdown.Converter({extensions: ['audio']});
            converter.setOption('tasklists', true);
            converter.setOption('ghCodeBlocks', true);
            converter.setOption('tables', true);
            converter.setOption('simpleLineBreaks', true);
            var text = editor.getValue();
            var html = converter.makeHtml(text);
            document.getElementById("preview").innerHTML = html;
            document.getElementById("pageContent").value = text;
            $('pre code').each(function (i, block) {
                hljs.highlightBlock(block);
            });
        }

        var pageTags = [[${page != null} ? ${@tagService.getPageTags(page.getCode())} : ${null}]];
        var users = [[${page != null} ? ${@userService.getPageMaintainers(page)} : ${null}]];

        $(document).ready(function () {
            setupForm(pageTags, users)
        });

        setTimeout(update, 500);
    </script>

</div>
</html>
